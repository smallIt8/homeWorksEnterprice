name: Create PR for docs and README update

on:
  push:
    branches:
      - content-update

permissions:
  contents: write
  pull-requests: write

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      docs_changed: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Забираем всю историю, чтобы корректно сравнивать с main
      - name: Fetch main branch explicitly
        run: git fetch origin main
      - name: Show changed files for debug
        run: git diff --name-only origin/main...HEAD
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs:
              - 'docs/**'
              - 'README.md'
              - '.github/**'

   create-pull-request:
    needs: filter
    runs-on: ubuntu-latest
    if: needs.filter.outputs.docs_changed == 'true'
    steps:
      - uses: actions/checkout@v3
        with:
          ref: content-update
          fetch-depth: 0  # нужно обязательно!
      
      - name: Fetch main branch
        run: git fetch origin main

      - name: Debug changed files
        run: git diff --name-status origin/main..HEAD
      
      - name: Create or update Pull Request to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Update docs and README.md'
          base: main
          branch: content-update  # <----- ВАЖНО: используем существующую ветку!
          title: 'Auto-update docs and README.md'
          body: |
            Этот PR автоматически создаётся/обновляется для синхронизации изменений из content-update в main.
          labels: docs, auto-generated
          draft: false
